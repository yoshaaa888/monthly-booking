# ADR 0001: キャンペーンは人力紐づけに一本化し、自動紐づけを廃止する

日付: 2025-08-20
ステータス: 提案（採用予定）

## 背景・コンテキスト
これまで本プラグインでは、以下のような「自動判定・自動紐づけ」的なキャンペーン適用が存在していた。
- 即入居割（直近 n 日以内の入居で割引）
- 早割（30 日以上前の予約で割引）
- 一部フラットレート系（期間・条件で定額）

運用上の課題:
- 自動条件がビジネス運用と齟齬を生みやすく、実際の販売判断と乖離するケースがある
- ルーム単位の在庫・売価戦略に即して「今この部屋に割引を出すべきか」を最終的に判断するのは人
- コード側の条件分岐（早割/即入居等）のメンテコスト・副作用リスクが高い
- 「見える化」と「すばやい手動操作」を優先し、誤適用のない安全な運用を第一とする方針へ転換する

## 決定（Decision）
- キャンペーン適用は「人力紐づけ」に一本化する
  - 管理画面から部屋単位・期間単位でのキャンペーン割当を行い、適用の有無を明示管理
  - 同一期間における同一部屋のキャンペーンは最大 1 件のみ（排他）
- 既存の「自動紐づけ/自動適用」ロジックは無効化する（機能フラグまたは呼出し停止）
  - 早割・即入居割などの自動判定は行わない
  - 既存コードはフェイルセーフとして当面残すが、実行経路から外す（後述の移行で詳細）
- 将来の AI 提案は「提案のみ」行い、実行（割当決定）は人が行う
  - UI 上に提案（候補）を提示しても、自動適用は行わない
  - 提案は監査ログと共に可視化し、人が明示的に採用する

## 目的・設計思想
- 人が最終意思決定する前提で、システムは
  - 状況の見える化（どの部屋に、いつ、何のキャンペーンがあるか）
  - すばやい手動操作（割当/解除/期間変更/無効化）ができる管理 UI
  に特化する
- ビジネスの裁量を尊重し、誤適用を避ける堅牢性を優先
- 将来の拡張（AI 提案、キャンペーン種別追加）に備え、データモデルと UI は人力割当を中心に据える

## 反対案（Alternatives）と却下理由
1) 自動判定を温存しつつ重み付け・優先度で調整
- 却下理由: 複雑性が増し、運用実態に合わせるための微調整コストが継続的に発生。誤適用時の説明責任も増大。

2) ハイブリッド（基本は自動、例外は手動上書き）
- 却下理由: 自動の影響を完全に把握しづらく、現場判断の確実性を損なう。UI/UX も複雑化。

3) 完全撤廃（キャンペーン自体を廃止）
- 却下理由: 販売戦略上の柔軟性を損なう。人力紐づけ運用なら安全性と機動性を両立可能。

## 影響（Impact）
- 管理 UI:
  - 部屋編集画面等に「キャンペーン割当」セクションを集約
  - 追加/編集/削除、期間バリデーション（重複禁止）、有効/無効トグル
  - 一覧の可視化と検索性向上
- 価格計算/見積・予約フロー:
  - 自動判定ロジックを通さず、当該部屋・期間に人が割当てたキャンペーンのみを適用
  - 最大 1 件のみ適用（重ね掛け禁止）
- データモデル/DB:
  - 既存のキャンペーンテーブルと部屋割当テーブルを正とし、状態は「誰が/いつ/どれを」割当てたかで一意に決定
  - 既存の自動系フラグ/記述は互換性維持のため当面保持するが、参照は停止
- 運用:
  - 値下げ判断は人が実施
  - 誤適用の責任・説明が明確になり、監査しやすくなる

## 移行方針（Transition Plan）
段階的・安全第一で移行する。

Phase 1: 停止準備
- 機能フラグで自動判定経路を無効化（早割・即入居等の自動適用を通さない）
- 既存データは保持し、価格計算に影響を与えないことを検証
- 管理 UI に「人力割当」機能が揃っていることを確認

Phase 2: 人力運用への切替
- 既存の自動キャンペーンに紐づいていた部屋・期間を棚卸しし、必要なものだけ手動で再割当
- 期間重複の禁止、1 部屋 1 キャンペーン/同期間の排他を厳守
- 価格計算・見積・予約の各フローで最大 1 件適用を再確認

Phase 3: フォローアップ
- ログ/監査の整備（誰が/いつ/何を割当てたか）
- ドキュメント/手順教育（現場向け）
- CI/E2E テストの更新（自動適用前提のケースを削除/置換）

Phase 4: レガシー縮退
- 一定期間後、未使用の自動判定コードを段階的に削除
- DB 上の自動用フィールドは互換を保ちつつ非推奨化を明示

## 非機能要件
- 可観測性: 割当履歴と適用結果の監査ログ
- 安全性: ダブルディスカウント禁止、境界値（7/30 日など）でも人力割当のみ適用
- 可用性: UI からの操作が即時反映されること

## 将来拡張: AI 提案は「提案のみ」
- 需要/在庫/競合価格から「この期間は割引提案」を表示
- 人が確認・採用した場合のみ割当作成
- 提案の採否・理由をログ化し、学習・改善に活用

## スコープ外
- 既存の自動ロジックの即時削除（まずは停止→検証→段階削除）
- 複数キャンペーン同時適用や複雑な優先度ルール（採用しない）

## 成功指標
- 誤適用のゼロ化（自動判定由来の事故防止）
- 管理 UI 経由の割当操作に要する時間短縮
- 運用現場による説明容易性の向上（意思決定の透明性）
