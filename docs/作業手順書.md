# 作業手順書（料金設定・オプション・キャンペーン整合性確認）

この手順書は、WordPress 月額宿泊システムの料金・オプション・キャンペーン設定の整合性確認を効率的かつ安全に行うためのものです。すべての操作は参照のみ（SELECT）で実施してください。

## 1. 前提と対象テーブル
- wp_monthly_rooms: 部屋基本情報（basic 日割り単価: daily_rent）
- wp_monthly_rates: レート（rate_type, base_price, valid_from/valid_to, is_active）
- wp_monthly_options: オプション（price, is_discount_target, display_order, is_active）
- wp_monthly_campaigns: キャンペーン（discount_type/value, applicable_rooms, 期間/有効フラグ）
- 環境によっては wp_monthly_room_campaigns を使用する場合があります（本リポ実装は applicable_rooms にCSVで保持）

## 2. SQL の実行方法（プレフィックス可変化）
SQLファイル: docs/sql/料金設定確認用SQLクエリ集.sql

- 方法A（MySQLユーザー変数 + PREPARE/EXECUTE）
  1) SET @p := 'wp_';
  2) 任意のテンプレートSQL文字列の {{PREFIX}} を @p に REPLACE
  3) PREPARE ... EXECUTE ... DEALLOCATE PREPARE
  サンプルはファイル末尾「付録」に記載

- 方法B（置換方式）
  - エディタで {{PREFIX}} を実DBのプレフィックス（例: wp_）に一括置換し、そのまま実行

注意: すべて SELECT のみです。LIMIT 20 と ORDER BY を含め、確認しやすい出力にしています。

## 3. チェックリストの使い方
- 料金設定確認表: docs/checklists/料金設定確認表.csv
  - 記入: 部屋ID/部屋名/部屋タイプ/SS/S/M/L 単価/基本日割り単価/更新日を「DB値」として転記
  - UI表示値: 管理画面またはフロントの表示値を記入
  - 差異有無: 有/無
  - 備考: 小数/税込税抜、端数処理、表示丸めなどの補足
  - 重要度: 高/中/低

- オプション設定確認表: docs/checklists/オプション設定確認表.csv
  - 記入: オプションID/名/価格/割引可否/有効無効/並び順
  - UI表示値・差異有無・備考・重要度を追記

- 見積もり検証表: docs/checklists/見積もり検証表.csv
  - テストケース: 例「即入居（7日以内）SS 10日・大人2/子供0・オプション2件」
  - 期間・部屋タイプ・人数・オプションを指定
  - 合計の期待値/実測値/差異に加え、ブレークダウン（基本料金, 人数追加料金, オプション料金, キャンペーン割引, 合計）を記録

## 4. 推奨検証フロー
1) 料金基礎確認
   - 1-1 全部屋基本設定一覧で daily_rent と is_active、更新日を確認
   - 1-2 レート（rate_typeごと）の base_price/期間/有効性を確認
2) キャンペーン確認
   - 1-3 アクティブキャンペーン一覧で期間内/有効を確認
   - applicable_rooms（CSV）で対象部屋を抽出（3-5）し、想定と一致するか確認
3) オプション確認
   - 2-1〜2-3 で価格/割引対象/並び順/有効無効を確認
4) 整合性チェック
   - 3-1 料金重複、3-2 欠損、3-3 オプション矛盾、3-4 キャンペーン期間重複
   - 環境に monthly_room_campaigns がある場合は 3-6 で紐付けを直接確認
   - 「1部屋1キャンペーン」原則の観点から 3-7 で多重適用のリスクを俯瞰
5) 見積もり検証
   - 見積もり検証表にテストケースを作成（SS 7–29日、S 30–89日、M 90–179日、L 180日以上）
   - 境界値（7/8日, 29/30日, 89/90日, 179/180日）・キャンペーン適用境界（≤7日, ≥30日）を重点確認
   - 人数追加料金、オプションセット割、キャンペーン割引適用順序にも注意

## 5. 重要度（高/中/低）の定義
- 高: 金額確定/請求金額に直結する誤り（レート重複、期間重複キャンペーンによる二重割引、税率誤り、表示金額と計算金額不一致）
- 中: ユーザー選択やUI表示に影響（並び順不整合、割引対象外の誤フラグ、無効オプションの表示）
- 低: 表示上の軽微な不整合（説明文の誤字、更新日の軽微なずれなど）

## 6. エスカレーション指針
- 「高」判定は即時エスカレーション（開発/運用リーダーに連絡、適用停止の回避策検討）
- 「中」は当日中に整理しPR/Issue作成、次リリースで修正
- 「低」は集約して定期メンテで対応

## 7. WordPress/DB に依存する注意点
- $wpdb->prefix を使用するため、環境でプレフィックスが異なる場合は必ず置換またはユーザー変数方式で実行
- dbDelta 互換の都合で外部キー制約が未設定な場合があります。重複/参照整合はアプリ側でも担保される設計が前提
- パフォーマンスのため、room_id, rate_type, is_active, valid_from/valid_to などに索引が張られています（実装参照）
- 本リポではキャンペーン対象は applicable_rooms（CSV）で管理。将来的な wp_monthly_room_campaigns への移行を想定する場合は、移行時のクエリを3-6のように差し替えてください

## 8. 成果物パス
- SQL: docs/sql/料金設定確認用SQLクエリ集.sql
- チェックリスト: docs/checklists/料金設定確認表.csv, オプション設定確認表.csv, 見積もり検証表.csv

以上
