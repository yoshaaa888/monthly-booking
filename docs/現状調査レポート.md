# 現状調査レポート（UI・DB不整合）

本レポートは、管理画面UI表示値とDB実値、ならびに計算ロジックの参照元の不整合を可視化します。すべて参照のみの分析です。

## 1. 主要コンポーネントと参照元
- 管理画面（includes/admin-ui.php）
  - 物件マスタ一覧: wp_{prefix}monthly_rooms を参照
  - オプション管理: wp_{prefix}monthly_options を参照（display_order で並び替え）
  - キャンペーン設定: 実装箇所あり（詳細は後述）
- 計算ロジック（includes/booking-logic.php）
  - ベース価格: get_option('monthly_booking_options')['default_price'] を参照
  - キャンペーン割引: wp_{prefix}monthly_booking_campaigns を参照
- キャンペーン管理（includes/campaign-manager.php）
  - キャンペーン取得: wp_{prefix}monthly_campaigns を参照
  - タイプ別取得: campaign_description を LIKE 条件で検索

## 2. 主要不整合の仮説（発見事項）
- テーブル名の不統一
  - booking-logic.php: wp_{prefix}monthly_booking_campaigns
  - campaign-manager.php: wp_{prefix}monthly_campaigns
  - 想定：月額用キャンペーンテーブルは monthly_campaigns で統一すべき
- カラム名の不一致
  - campaign-manager は campaign_name/campaign_description を参照
  - booking-logic は name など異なるカラム想定の可能性
- 料金計算の参照元の差異
  - UIやDBの monthly_rates（rate_type=SS/S/M/L, base_price 等）がある一方、
  - booking-logic は default_price（オプション値）を使用しており、レート表を未使用

これらは「UI表示」と「実計算値」の不一致を引き起こす可能性が高いです。

## 3. データフロー（概観）
UI入力 → DB保存（rooms/options/campaigns） → 見積もり計算（booking-logic）  
現状、計算時の「料金参照源」が options の default_price に偏っており、レート表（月単位/SS,S,M,L）を参照していない。

## 4. 追加調査の必要箇所
- admin-ui.php 内のキャンペーン設定ページの保存・表示で使っている実テーブル・カラムの列挙
- monthly_rates の読み取り箇所の有無（検索時点で未使用の可能性）
- booking-logic.php での options_total / 人数加算 / 税区分などの内部計算詳細（UI表示と一致するか）

## 5. 暫定結論
- 「キャンペーン」テーブルの二系統（monthly_campaigns / monthly_booking_campaigns）混在
- 「料金」参照元が UI/DB の想定（月レート）と実計算（default_price）で不一致

## 6. 次のアクション（別資料: 修正計画.md に詳細記載）
- 名称とスキーマの統一方針の決定（テーブル/カラム）
- booking-logic が monthly_rates を参照できるようにする設計案の提示
- 移行影響度の評価と段階的マイグレーション計画の立案

以上
