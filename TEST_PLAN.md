# キャンペーン自動適用ロジック テスト計画書

## 概要
`get_best_applicable_campaign_for_room()` 関数と、それが統合された料金計算ロジックの網羅的なテスト計画書です。

## テスト対象
- `includes/campaign-manager.php` の `get_best_applicable_campaign_for_room()` 関数
- `includes/booking-logic.php` の料金計算統合ロジック
- 部屋別キャンペーン自動選択機能

## テストケース一覧

| テストケースID | テストシナリオ | 事前条件 | テスト手順 | 期待される結果 |
|---|---|---|---|---|
| **TC-01** | 「即入居割」が条件（チェックイン7日以内）を満たした時に正しく適用される | ・部屋ID=1に「即入居割」キャンペーン（20%OFF）が割り当て済み<br>・キャンペーン適用期間内<br>・キャンペーンステータス=有効 | 1. チェックイン日を今日から5日後に設定<br>2. チェックアウト日を15日後に設定<br>3. `get_best_applicable_campaign_for_room(1, checkin, checkout, 100000)` を実行 | ・「即入居割」キャンペーンが返される<br>・discount_amount = 20000<br>・campaign_type = 'immediate'<br>・days_until_checkin = 5 |
| **TC-02** | 「早割」が条件（チェックイン30日以上前）を満たした時に正しく適用される | ・部屋ID=2に「早割」キャンペーン（10%OFF）が割り当て済み<br>・キャンペーン適用期間内<br>・キャンペーンステータス=有効 | 1. チェックイン日を今日から35日後に設定<br>2. チェックアウト日を65日後に設定<br>3. `get_best_applicable_campaign_for_room(2, checkin, checkout, 150000)` を実行 | ・「早割」キャンペーンが返される<br>・discount_amount = 15000<br>・campaign_type = 'earlybird'<br>・days_until_checkin = 35 |
| **TC-03** | 「コミコミプラン」が条件（7〜10日滞在）を満たした時に正しく適用される | ・部屋ID=3に「コミコミプラン」キャンペーン（100000円固定）が割り当て済み<br>・キャンペーン適用期間内<br>・キャンペーンステータス=有効 | 1. チェックイン日を今日から15日後に設定<br>2. チェックアウト日を23日後に設定（8日滞在）<br>3. `get_best_applicable_campaign_for_room(3, checkin, checkout, 120000)` を実行 | ・「コミコミプラン」キャンペーンが返される<br>・discount_amount = 20000（120000-100000）<br>・campaign_type = 'flatrate'<br>・priority = 999999 |
| **TC-04** | 「即入居割」と「コミコミプラン」の両方の条件を満たす場合、「コミコミプラン」が最優先で適用される | ・部屋ID=4に以下2つのキャンペーンが割り当て済み：<br>　- 「即入居割」（20%OFF）<br>　- 「コミコミプラン」（100000円固定）<br>・両方とも適用期間内・有効 | 1. チェックイン日を今日から5日後に設定<br>2. チェックアウト日を13日後に設定（8日滞在）<br>3. `get_best_applicable_campaign_for_room(4, checkin, checkout, 120000)` を実行 | ・「コミコミプラン」キャンペーンが返される<br>・「即入居割」は適用されない<br>・返される配列の要素数 = 1<br>・campaign_type = 'flatrate' |
| **TC-05** | 割引率が異なる2つのキャンペーン（例: 15%OFFと20%OFF）が適用可能な場合、割引額が最も高い方（20%OFF）が自動選択される | ・部屋ID=5に以下2つのキャンペーンが割り当て済み：<br>　- キャンペーンA（15%OFF）<br>　- キャンペーンB（20%OFF）<br>・両方とも同じタイプ・適用期間内・有効 | 1. 両キャンペーンの条件を満たす日程を設定<br>2. `get_best_applicable_campaign_for_room(5, checkin, checkout, 100000)` を実行 | ・20%OFFキャンペーンが返される<br>・discount_amount = 20000<br>・15%OFFキャンペーンは適用されない<br>・返される配列の要素数 = 1 |
| **TC-06** | いかなる場合でも、複数のキャンペーンが同時に適用され、二重割引が発生しないことを確認する | ・部屋ID=6に複数の異なるタイプのキャンペーンが割り当て済み<br>・すべて適用条件を満たす設定 | 1. 複数キャンペーンの条件を満たす日程を設定<br>2. `get_best_applicable_campaign_for_room(6, checkin, checkout, 100000)` を実行<br>3. 返り値の構造を確認 | ・返される配列の要素数 = 1<br>・最優先キャンペーンのみが返される<br>・複数キャンペーンの合計割引は適用されない |
| **TC-07** | チェックイン日がちょうど7日後の場合、「即入居割」が適用される | ・部屋ID=7に「即入居割」キャンペーンが割り当て済み<br>・キャンペーン適用期間内・有効 | 1. チェックイン日を今日から**ちょうど7日後**に設定<br>2. チェックアウト日を17日後に設定<br>3. `get_best_applicable_campaign_for_room(7, checkin, checkout, 100000)` を実行 | ・「即入居割」キャンペーンが返される<br>・days_until_checkin = 7<br>・キャンペーンが正常に適用される |
| **TC-08** | チェックイン日が8日後の場合、「即入居割」が適用されない | ・部屋ID=8に「即入居割」キャンペーンが割り当て済み<br>・キャンペーン適用期間内・有効 | 1. チェックイン日を今日から**8日後**に設定<br>2. チェックアウト日を18日後に設定<br>3. `get_best_applicable_campaign_for_room(8, checkin, checkout, 100000)` を実行 | ・null が返される（グローバルキャンペーンにフォールバック）<br>・「即入居割」は適用されない<br>・days_until_checkin = 8 > 7 のため除外 |
| **TC-09** | チェックイン日がちょうど30日後の場合、「早割」が適用される | ・部屋ID=9に「早割」キャンペーンが割り当て済み<br>・キャンペーン適用期間内・有効 | 1. チェックイン日を今日から**ちょうど30日後**に設定<br>2. チェックアウト日を60日後に設定<br>3. `get_best_applicable_campaign_for_room(9, checkin, checkout, 100000)` を実行 | ・「早割」キャンペーンが返される<br>・days_until_checkin = 30<br>・キャンペーンが正常に適用される |
| **TC-10** | チェックイン日が29日後の場合、「早割」が適用されない | ・部屋ID=10に「早割」キャンペーンが割り当て済み<br>・キャンペーン適用期間内・有効 | 1. チェックイン日を今日から**29日後**に設定<br>2. チェックアウト日を59日後に設定<br>3. `get_best_applicable_campaign_for_room(10, checkin, checkout, 100000)` を実行 | ・null が返される（グローバルキャンペーンにフォールバック）<br>・「早割」は適用されない<br>・days_until_checkin = 29 < 30 のため除外 |
| **TC-11** | 滞在日数がちょうど7日間の場合、「コミコミプラン」が適用される | ・部屋ID=11に「コミコミプラン」キャンペーンが割り当て済み<br>・キャンペーン適用期間内・有効 | 1. チェックイン日を今日から15日後に設定<br>2. チェックアウト日を22日後に設定（**ちょうど7日滞在**）<br>3. `get_best_applicable_campaign_for_room(11, checkin, checkout, 100000)` を実行 | ・「コミコミプラン」キャンペーンが返される<br>・stay_days = 7<br>・キャンペーンが正常に適用される |
| **TC-12** | 滞在日数がちょうど10日間の場合、「コミコミプラン」が適用される | ・部屋ID=12に「コミコミプラン」キャンペーンが割り当て済み<br>・キャンペーン適用期間内・有効 | 1. チェックイン日を今日から15日後に設定<br>2. チェックアウト日を25日後に設定（**ちょうど10日滞在**）<br>3. `get_best_applicable_campaign_for_room(12, checkin, checkout, 100000)` を実行 | ・「コミコミプラン」キャンペーンが返される<br>・stay_days = 10<br>・キャンペーンが正常に適用される |
| **TC-13** | どのキャンペーンの条件にも合致しない場合、割引は適用されず、通常料金で計算される | ・部屋ID=13に各種キャンペーンが割り当て済み<br>・すべてのキャンペーンの適用条件を満たさない日程 | 1. チェックイン日を今日から15日後に設定（即入居割×、早割×）<br>2. チェックアウト日を20日後に設定（5日滞在、コミコミプラン×）<br>3. `get_best_applicable_campaign_for_room(13, checkin, checkout, 100000)` を実行 | ・null が返される（グローバルキャンペーンにフォールバック）<br>・部屋別キャンペーンは適用されない<br>・通常料金で計算される |
| **TC-14** | 部屋にキャンペーンが割り当てられているが、そのステータスが「無効」の場合、割引は適用されない | ・部屋ID=14に「即入居割」キャンペーンが割り当て済み<br>・**キャンペーンステータス=無効（is_active=0）**<br>・その他の条件は満たす | 1. チェックイン日を今日から5日後に設定<br>2. チェックアウト日を15日後に設定<br>3. `get_best_applicable_campaign_for_room(14, checkin, checkout, 100000)` を実行 | ・null が返される（グローバルキャンペーンにフォールバック）<br>・無効なキャンペーンは除外される<br>・SQLクエリのWHERE条件で除外される |
| **TC-15** | 予約しようとしている期間が、部屋に割り当てられたキャンペーンの適用期間外である場合、割引は適用されない | ・部屋ID=15に「即入居割」キャンペーンが割り当て済み<br>・キャンペーン適用期間: 2025-01-01〜2025-01-31<br>・**予約期間が適用期間外** | 1. チェックイン日を2025-02-05に設定（適用期間外）<br>2. チェックアウト日を2025-02-15に設定<br>3. `get_best_applicable_campaign_for_room(15, checkin, checkout, 100000)` を実行 | ・null が返される（グローバルキャンペーンにフォールバック）<br>・期間外のキャンペーンは除外される<br>・SQLクエリの期間重複条件で除外される |

## テスト実行環境
- PHP 7.4以上
- WordPress 5.0以上
- MySQL/MariaDB
- 必要なテーブル: `wp_monthly_campaigns`, `wp_monthly_room_campaigns`

## テストデータ準備
各テストケース実行前に、以下のテストデータを準備する必要があります：

### キャンペーンマスタデータ
```sql
INSERT INTO wp_monthly_campaigns (campaign_name, campaign_description, discount_type, discount_value, type, is_active) VALUES
('即入居割', '7日以内の入居で20%OFF', 'percentage', 20, 'immediate', 1),
('早割', '30日前予約で10%OFF', 'percentage', 10, 'earlybird', 1),
('コミコミプラン', '7-10日滞在で10万円固定', 'flatrate', 100000, 'flatrate', 1);
```

### 部屋キャンペーン割当データ
各テストケースに応じて、`wp_monthly_room_campaigns` テーブルにテストデータを投入する。

## 検証ポイント
1. **関数戻り値の構造**: 期待される配列構造が返されるか
2. **優先度ロジック**: flatrate > 割引額の順序で正しくソートされるか
3. **条件判定**: 各キャンペーンタイプの適用条件が正確に判定されるか
4. **排他制御**: 複数キャンペーンが同時適用されないか
5. **フォールバック**: 部屋別キャンペーンがない場合のグローバルキャンペーン適用
6. **統合テスト**: booking-logic.php との統合が正常に動作するか

## 自動テスト実装
各テストケースは、PHPUnitまたは独自のテストスクリプトとして実装し、継続的インテグレーション（CI）で自動実行できるようにする。

## 注意事項
- テスト実行前に、本番データのバックアップを取得すること
- テスト用データベースを使用し、本番環境での直接テストは避けること
- 日付計算のテストでは、タイムゾーンの影響を考慮すること
- キャンペーン期間の境界値テストでは、日付の包含・除外ロジックを慎重に検証すること
