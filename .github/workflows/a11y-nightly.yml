name: a11y-nightly

on:
  schedule:
    - cron: '0 1 * * *' # 1 AM UTC
  workflow_dispatch: {}
  pull_request:
    branches: ["*"]
    types: [opened, synchronize, reopened, labeled]

jobs:
  a11y:
    # PR の場合は 'ci:a11y' ラベルが付いているときのみ実行
    if: >
      github.event_name != 'pull_request' ||
      contains(join(fromJson(toJson(github.event.pull_request.labels)).*.name, ','), 'ci:a11y')
    runs-on: ubuntu-latest
    timeout-minutes: 25
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # === docker-compose ENOENT 対策：公式リリースから直接取得 ===
      - name: Install docker-compose (shim for wp-env)
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          /usr/local/bin/docker-compose version

      - name: Docker sanity
        run: |
          docker --version
          docker compose version || true

      # === wp-env 起動（post-mergeパターン踏襲） ===
      - name: Install @wordpress/env globally
        run: npm i -g @wordpress/env

      - name: Start WordPress env
        env:
          DOCKER_COMPOSE_CMD: "docker compose"
        run: wp-env start

      # === 共通セットアップ（DB待機 / WP初期化 / プラグイン / パーマリンク / ページ） ===
      - name: Make wp-setup executable
        run: chmod +x .github/scripts/wp-setup.sh

      # === Patch D: 環境サニティチェック ===
      - name: Env sanity
        run: |
          which wp-env || true
          wp-env --version || true
          which docker-compose || true
          docker compose version || true
          echo "DOCKER_COMPOSE_CMD=${DOCKER_COMPOSE_CMD:-unset}"

      - name: WordPress bootstrap (shared script)
        env:
          DB_WAIT_MAX: "60"
          DB_WAIT_INTERVAL: "2"
        run: .github/scripts/wp-setup.sh

      # === Patch A: PlaywrightにbaseURLを渡す ===
      - name: Export PW_BASE_URL from WP
        run: echo "PW_BASE_URL=$(npx wp-env run cli -- wp option get home)" >> $GITHUB_ENV

      # === Patch B: カレンダーページとパーマリンクを再度強制 ===
      - name: Finalize permalinks & calendar page (idempotent)
        run: |
          npx wp-env run cli -- wp rewrite structure '/%postname%/' --hard
          npx wp-env run cli -- wp rewrite flush --hard
          PID=$(npx wp-env run cli -- "wp post list --post_type=page --pagename=monthly-calendar --field=ID")
          if [ -z "$PID" ]; then
            npx wp-env run cli -- wp post create --post_type=page --post_status=publish --post_title='Monthly Calendar' --post_name='monthly-calendar' --post_content='[monthly_calendar]'
          fi

      # === Patch C: Health check を実URLで ===
      - name: Health check /monthly-calendar/ (HTTP 200)
        run: |
          URL="${PW_BASE_URL%/}/monthly-calendar/"
          echo "Checking ${URL}"
          for i in {1..30}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
            echo "Attempt $i: $code"
            [ "$code" = "200" ] && exit 0
            sleep 2
          done
          exit 1

      # === a11y テスト実行 ===
      - name: Install Playwright chromium only
        run: npx playwright install --with-deps chromium

      - name: Run a11y suite
        run: npx playwright test --grep @a11y --project=chromium --reporter=list,html
        env:
          CI: true
          PW_BASE_URL: ${{ env.PW_BASE_URL }}

      - name: Upload a11y report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: a11y-report
          path: |
            a11y-report/**
            playwright-report/**
            axe-report/**
            ./**/a11y-report/**

      # === 失敗時のデバッグ収集 ===
      - name: Collect debug artifacts (if fail)
        if: failure()
        run: |
          mkdir -p a11y-debug
          npx wp-env run cli "wp core is-installed" > a11y-debug/core-installed.txt || true
          npx wp-env run cli "wp option get siteurl" > a11y-debug/siteurl.txt || true
          npx wp-env run cli "wp option get home" > a11y-debug/home.txt || true
          npx wp-env run cli "wp option get permalink_structure" > a11y-debug/permalink.txt || true
          npx wp-env run cli "wp post list --post_type=page --fields=ID,post_title,post_name,post_status" > a11y-debug/pages.txt || true
          npx wp-env run cli "wp plugin list" > a11y-debug/plugins.txt || true
          npx wp-env run cli "wp rewrite list" > a11y-debug/rewrite-rules.txt || true
          cp -f wp-content/debug.log a11y-debug/debug.log || true

      - name: Upload a11y debug artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: a11y-debug
          path: a11y-debug/**
          retention-days: 7
